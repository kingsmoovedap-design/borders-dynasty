# Borders Dynasty - Web3 DeFi Platform

## Overview
A Web3 DeFi sovereign blockchain platform for the CodexChain/Borders Dynasty ecosystem. Features an upgradeable ERC20 token (Borders Sovereign Coin/BSC) with advanced governance controls, token transfers, minting, blacklisting, and on-chain document verification.

## Live Deployment
- **Contract Address**: `0x12efC9a5D115AE7833c9a6D79f1B3BA18Cde817c` (Sepolia)
- **Implementation**: `0xa0aE7B3bf4BB6e47Eebf858e50A34A570E156582` (Verified on Etherscan)
- **Sovereign Wallet**: `0xE89fDED72D0D83De3421C6642FA035ebE197804f`

## Web3 DeFi Features
- **Wallet Connection**: MetaMask/Web3 wallet integration with auto network switching
- **Token Transfers**: Send BSC tokens to any address
- **Minting**: Admin minting with MINTER_ROLE permission
- **Blacklisting**: Security controls with GUARD_ROLE permission
- **Document Registry**: On-chain document hash verification
- **Network Detection**: Auto-prompts to switch to Sepolia network
- **Real-time Balance**: Live balance updates after transactions
- **Transaction Logging**: Activity feed with transaction status

## Project Structure
- `src/` - Frontend source files (index.js, index.html)
- `src/abis/` - Contract ABIs (auto-synced from compiled artifacts)
- `public/` - Static assets (manifest.json for PWA)
- `apps/api/` - Express logistics API with Codex integration
  - `src/routes/` - API route definitions
  - `src/controllers/` - Request handlers
  - `src/services/` - Business logic
  - `src/codex/` - Codex Ecclesia client
- `packages/codex/` - Codex Ecclesia service and client
- `packages/freight-logic/` - FreightEngine with mode validation
- `packages/ops-config/` - Global ops readiness and activation flags
- `packages/treasury/` - TreasuryEngine for BSC token escrow and payouts
- `packages/devine-credit/` - DevineCredit system for driver credit lines
- `packages/ecclesia-client/` - Client for Codex Ecclesia public API
- `packages/ai-dispatch/` - AI dispatch suggestion engine
- `packages/loadboard/` - Multi-view loadboard (shipper/driver/ops/omega)
- `packages/loyalty/` - Driver Loyalty System (5-tier progression with benefits)
- `packages/compliance/` - Compliance Engine (mode/region/cargo rule validation)
- `packages/risk-radar/` - Risk Radar (6-category composite risk scoring)
- `packages/rewards/` - Reward System (badges, streaks, redemption marketplace)
- `apps/omega/` - Omega Portal web console for leadership control
- `contracts/` - Solidity smart contracts (BordersSovereignCoin, DynasticIdentity, ScrollHashRegistry)
- `scripts/` - Deployment and utility scripts (including syncAbis.js)
- `artifacts/` - Compiled contract artifacts (generated by Hardhat)
- `test/` - Test files
- `dist/` - Built output (generated)
- `.openzeppelin/` - Proxy deployment manifests

## Global Ops Configuration
Modes: GROUND, AIR, OCEAN, COURIER
Regions: NORTH_AMERICA, EUROPE, ASIA_PACIFIC, LATAM

### Ops API Endpoints
- `GET /ops/status` - View mode/region readiness and activation status
- `POST /ops/activate-mode` - Activate a mode (body: { mode })
- `POST /ops/deactivate-mode` - Deactivate a mode (body: { mode })
- `POST /ops/activate-region` - Activate a region (body: { region }) - only if ready
- `POST /ops/global-launch` - Activate all modes + NORTH_AMERICA/EUROPE at once
- `POST /ops/staged-launch` - Execute staged launch (body: { stage: LOCAL|NATIONWIDE|GLOBAL })
- `GET /ops/launch-plan/:stage` - Get launch plan for a stage
- `POST /ops/set-region-ready` - Mark a region as ready (body: { region })

## Treasury API Endpoints
- `GET /treasury/balance` - Get escrow balance and payout count
- `GET /treasury/payouts` - List all payouts issued

## DevineCredit API Endpoints
- `POST /drivers` - Register driver with credit line (body: { driverId, name, homeBase, equipment })
- `GET /drivers/:id` - Get driver info and credit line
- `GET /drivers/:id/credit` - Get driver credit status
- `POST /drivers/:id/advance` - Issue credit advance (body: { amount, loadId })
- `GET /credit/lines` - List all credit lines
- `GET /credit/transactions` - List all credit transactions

## Loadboard API Endpoints
- `GET /loadboard/shipper/:shipperId` - Shipper's view of their loads
- `GET /loadboard/driver/:driverId` - Driver's assigned & available loads
- `GET /loadboard/ops` - Ops dashboard with alerts and breakdowns
- `GET /loadboard/omega` - Leadership view with treasury & credit stats

## Dispatch API Endpoints
- `GET /dispatch/suggest/:loadId` - AI driver suggestions with scoring
- `GET /dispatch/evaluate/:loadId` - AI load profitability analysis
- `POST /dispatch/assign` - Assign driver to load (body: { loadId, driverId, method })
- `GET /dispatch/history` - View all dispatch records
- `GET /dispatch/integrated/:loadId` - Integrated dispatch with loyalty, compliance, risk, rewards data
- `POST /contract/accept` - Accept load contract (body: { loadId, driverId })
- `GET /contracts` - List all accepted contracts
- `GET /contracts/:id` - Get contract by ID
- `GET /contracts/load/:loadId` - Get contract for a specific load

## Loyalty System API Endpoints
- `GET /loyalty/tiers` - Get all loyalty tiers and point actions
- `GET /loyalty/driver/:driverId` - Get driver loyalty status and benefits
- `POST /loyalty/award` - Award loyalty points (body: { driverId, action, multiplier })
- `GET /loyalty/leaderboard` - Get points leaderboard
- `GET /loyalty/stats` - Get tier distribution stats
- `GET /loyalty/history/:driverId` - Get driver points history

## Compliance Engine API Endpoints
- `GET /compliance/rules` - Get all compliance rules (mode, region, cargo)
- `POST /compliance/check` - Run compliance check (body: { loadId, driverData, loadData })
- `POST /compliance/exception` - Log compliance exception (body: { loadId, driverId, exceptionType, reason })
- `GET /compliance/exceptions` - Get compliance exceptions with filters
- `GET /compliance/stats` - Get compliance statistics

## Risk Radar API Endpoints
- `GET /risk/overview` - Get regional risk overview and stats
- `POST /risk/assess` - Run risk assessment (body: { loadId, loadData, driverData })
- `GET /risk/load/:loadId` - Get risk assessment for specific load
- `GET /risk/history` - Get risk assessment history with filters
- `GET /risk/stats` - Get risk statistics

## Rewards System API Endpoints
- `GET /rewards/options` - Get badges, streaks, and redemption options
- `GET /rewards/driver/:driverId` - Get driver rewards and active boosts
- `POST /rewards/award` - Award rewards (body: { driverId, rewardType, value, reason })
- `POST /rewards/badge` - Award badge (body: { driverId, badgeId })
- `POST /rewards/redeem` - Redeem rewards (body: { driverId, option })
- `GET /rewards/history` - Get reward history
- `GET /rewards/stats` - Get reward system statistics

## Devine Dispatch API Endpoints (External Contract Gathering)
- `GET /devine-dispatch/partners` - List external loadboard partners and status
- `POST /devine-dispatch/gather` - Gather contracts from all external loadboards
- `GET /devine-dispatch/contracts` - List gathered contracts with filters
- `GET /devine-dispatch/qualified` - Get Dynasty-qualified contracts (score >= 60, redirectable)
- `POST /devine-dispatch/convert/:contractId` - Convert external contract to Dynasty load
- `GET /devine-dispatch/stats` - Dispatch statistics by mode

## Security API Endpoints
- `GET /security/status` - Security status, blocked IPs, protection config
- `GET /security/events` - Recent security events
- `POST /security/block-ip` - Manually block IP (body: { ip, reason })
- `POST /security/unblock-ip` - Unblock IP (body: { ip })

## Token Integration API Endpoints
- `POST /token/escrow/deposit` - Deposit BSC to escrow (body: { loadId, amount, depositorAddress })
- `GET /token/escrow/:loadId` - Get escrow balance for load
- `POST /token/payout/:loadId` - Process delivery payout (body: { driverWallet })
- `POST /token/credit/advance` - Issue credit advance with token (body: { driverId, amount, driverWallet })
- `POST /token/credit/repay` - Process credit repayment (body: { driverId, amount, driverWallet })
- `GET /token/transactions` - List token transactions with filters
- `GET /token/treasury/stats` - Treasury statistics and balances

## Authentication API Endpoints
- `POST /auth/omega/login` - Omega leadership login (body: { accessCode })
- `POST /auth/refresh` - Refresh access token (body: { refreshToken })
- `POST /auth/logout` - End session (requires auth)
- `GET /auth/me` - Get current user info (requires auth)
- `POST /auth/api-keys` - Create partner API key (omega only)
- `GET /auth/api-keys` - List API keys (omega only)
- `DELETE /auth/api-keys/:keyId` - Revoke API key (omega only)
- `GET /auth/access-logs` - View access logs (omega only)

## Audit API Endpoints
- `GET /audit/stats` - Audit statistics (omega only)
- `GET /audit/entries` - Query audit log with filters (omega only)
- `POST /audit/report` - Generate compliance report (omega only)
- `GET /audit/verify` - Verify chain integrity (omega only)

## Live Intel API Endpoints
- `GET /intel/status` - Orchestrator status, source health, and cache info
- `GET /intel/all` - All live intelligence data from all sources
- `GET /intel/market` - Freight rates, fuel prices, and treasury insights
- `GET /intel/operational` - Weather, traffic, and port status
- `GET /intel/partners` - Partner loadboard status and availability
- `GET /intel/alerts` - Active alerts from all intel sources
- `GET /intel/dispatch/:region/:mode` - Dispatch adjustments based on live conditions
- `GET /intel/treasury` - Treasury insights with market intelligence

## Governance API Endpoints
- `GET /governance/constitution` - Dynasty OS constitution and IP ownership

## Logistics API Endpoints
- `GET /health` - Health check with supported modes
- `GET /loads` - List all loads
- `POST /loads` - Create load (body: { shipperId, origin, destination, mode, budgetAmount, region })
- `GET /loads/:id` - Get load by ID
- `POST /loads/:id/in-transit` - Mark load in transit
- `POST /loads/:id/delivered` - Mark load as delivered

## Environment Variables
- `CODEX_URL` - URL of Codex Ecclesia service (default: http://localhost:3001)
- `API_PORT` - Port for Logistics API (default: 3000)

## Monorepo Services
The project runs two services:
- **Logistics API** (port 3000) - FreightEngine-powered load management
- **Codex Ecclesia** (port 3001) - Hash-chain record keeping with anchoring

Start both with: `node server.cjs`

## Codex Ecclesia Endpoints
- `GET /health` - Health check
- `POST /codex/records` - Create a hash-chained record
- `GET /codex/records` - List all records
- `POST /codex/anchors` - Create merkle root anchor
- `GET /codex/anchors` - List all anchors

## Smart Contracts
- **BordersSovereignCoin.sol**: Upgradeable ERC20 with MINTER_ROLE, GUARD_ROLE, blacklist, pausable, 1M cap
- **DynasticIdentity.sol**: Soulbound NFT for royal titles and sovereign recognition
- **ScrollHashRegistry.sol**: On-chain document verification via keccak256 hashes

## Database
PostgreSQL database with Drizzle ORM for persistent storage:
- `shared/schema.ts` - Drizzle schema definitions (loads, drivers, contracts, credit lines, payouts)
- `server/db.ts` - Database connection pool
- `drizzle.config.ts` - Drizzle Kit configuration
- Run `npm run db:push` to sync schema changes

## Development
- Run `npm run dev` to start the webpack dev server on port 5000
- Run `npm run build` to create production bundle in `dist/`
- Run `npm run compile` to compile Solidity contracts
- Run `npm run sync:abis` to sync compiled ABIs to src/abis/
- Run `npm run compile:sync` to compile and sync ABIs in one command
- Run `npx hardhat run scripts/deploy-upgradeable.js --network sepolia` to deploy contracts

## Key Configuration
- Webpack bundles the app with babel transpilation
- Dev server configured on port 5000 with hot reloading and WebSocket fix
- Hardhat configured for Ethereum development (Sepolia network)
- OpenZeppelin Upgrades plugin for transparent proxy pattern

## Cross-Repository Integration
- **Codex Ecclesia**: Synchronized via ECCLESIA_INTEGRATION_URL and DYNASTY_SHARED_SECRET
- **Nation Sovereign ID**: DYNASTY-BORDERS-001
- **Public Notice URL**: https://codex-ecclesia-public.onrender.com/api/notices

## Compliance
- QFS-Compatible Architecture (v1.0)
- ISO-20022 Ready
- Full Etherscan verification

## Deployment
Static deployment configured - builds with webpack and serves from `dist/` directory.
Render.yaml configured for automated deployment with environment secrets.
